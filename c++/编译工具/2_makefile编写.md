[toc]
# 1 makefile介绍
在学习C程序的编译过程中，我们知道编译一个程序还比较简单， 如果要编译多个文件，或者不同文件夹中的文件，需要生成不同的库文件，以及确定这些文件的编译先后顺序，往往所需要的命令行特别多，而且比较复杂，甚至对于以后项目的维护也比较麻烦。
那么这个时候如果我们能够把所有的编译规则全部规范到文件中，然后通过解析该文件去执行对应的编译指令，这样就大大简化指令的复杂度，同时降低了编译程序过程中所带来的错误。
根据上面的需求就产生了Makefile,我们的编译和处理规则就放在Makefile文件中，通过Makefile工具解析Makefile文件中的命令来指导整个工程的编译过程。
在学习makefile语法之前先学习gcc/g++命令的用法，因为makefile对工程进行编译的时候也是用的gcc/g++进行编译的。

# 2 gcc/g++命令
gcc/g++命令是用于将c/c++代码文件编译成可执行程序/库文件的命令。
gcc和g++命令的使用基本相同，下面就以gcc为例来讲解其使用
## 2.1 gcc编译器工作流程
![makefile1](img/makefile1.png)
对于一个c源文件在变成可执行文件前需要经历4个步骤：预处理，编译、汇编、链接

**预处理**：将头文件展开、将用到的所有的宏定义替换、去掉所有注释。
处理完成过后也会生成一个c文件，这个c文件就是纯代码。对应的命令为： ```gcc -E <源文件> -o  <生成.i文件>```参数-E表明需要生成一个c文件， -o的意思是为生成的目标指定一个名字
**编译**: 将.i文件生成.s汇编文件. 对应的命令为```gcc -S <.i源文件> -o  <生成.s汇编文件>```
**汇编**: 将.s汇编文件生成.o二进制文件。```gcc -c <.s汇编文件> -o  <生成.o二进制文件>```
**链接**：将二进制文件与其他库文件链接，成为一个可执行程序。

## 2.2 包含头文件
当源文件中需要包含其他头文件是使用参数-I来执行包含该头文件的目录：
```shell
gcc -c <源文件> -I <头文件路径> -o <可执行程序>
```

## 2.3 定义宏变量
在编译的时候可以给程序添加宏定义，这样在程序中就定义了该宏，可以用于条件编译。
```shell
gcc -c <源文件> -D <宏定义名> -o <可执行程序>
```
如果要添加多个宏定义，就再添加一次```-D <宏定义名>```

## 2.4 编译时添加库
有时候我们在程序中会用到其他的库文件，那么在编译的时候就需要把对应的库名添加进去，用于在链接的时候构建程序。
```shell
gcc -c <源文件> -L <库所在的路径> -l <库的名字> -o <目标文件>
```
<font color=gray>
注意：1. 库的名字可以去掉前缀lib和后缀.a/.so, 例如一个库的名字叫libEGL.so, 那么我们在执行gcc命令添加该库的时候可以只写EGL.
</font>

## 2.5 编译静态库

```shell
# 先将源码文件编译成.o的目标文件
gcc -c <源文件> -o <目标文件> 

# 再将.o文件编译成静态连接库
ar rcs <静态库名称> <.o目标文件1> <.o目标文件2> ...
```

## 2.6 编译动态库
```shell
gcc -fPIC -shared 源文件名... -o 动态链接库名
```
- shared 选项用于生成动态链接库；
- fpic（还可写成 -fPIC）选项的功能是，令 GCC 编译器生成动态链接库（多个目标文件的压缩包）时，表示各目标文件中函数、类等功能模块的地址使用相对地址，而非绝对地址。这样，无论将来链接库被加载到内存的什么位置，都可以正常使用。

## 2.7 编译的时候输出警告信息
如果需要在编译的时候输出警告信息，只需要在gcc/g++参数中添加-Wall即可。
```shell
gcc -c <源文件> -Wall -o <目标文件>
```

## 2.8 编译的时添加调试信息
当我们需要使用gdb进行调试的时候，需要先在编译选项中添加-g参数，这样编译出来的执行文件才能使用gdb调试。
```shell
gcc -c <源文件> -g -o <目标文件>
```

# 3 makefile示例

**编译执行文件**:

```makefile
# 目标文件
TARGET := test

# 源文件
SRCS :=
SRCS += main.cpp
SRCS += tools.cpp

# 中间对象
OBJ := $(subst .cpp,.o,$(SRCS) )

# 寻找头文件的路径
INCLUDE_DIR :=
INCLUDE_DIR += -I ./

# 寻找库文件路径
LIB_PATH :=
LIB_PATH += -L /usr/local/lib

# 宏定义
DEFINE :=
DEFINE += -D STB_IMAGE_WRITE_IMPLEMENTATION

# 编译命令
CXX = g++

# 编译选项
CXXFLAGS = -std=c++23 -Wall -Wextra

$(TARGET):$(OBJ)
	$(CXX) $^ $(CXXFLAGS) -o $@

%.o:%.cpp
	$(CXX) -c $^ $(INCLUDE_DIR) $(CXXFLAGS) $(DEFINE) -o $@

clean:
	-rm $(OBJ) $(TARGET)
```
