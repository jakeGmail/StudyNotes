
1 **imagemagick**

环境安装：
```shell
# 对于windows下，可先安装wsl
wsl --install -d Ubuntu # 安装Ubuntu的子系统
wsl -d Ubuntu -u root # 启动wsl终端

# 需要在ubuntu环境下
# 环境安装
sudo apt install -y imagemagick
```

作用：通用的图像编解码与处理引擎，包含但不限于以下作用。
`convert` 是 **ImageMagick 6.x** 中的核心工具之一，在 Ubuntu / WSL 环境里非常常见。它的能力远不止“改 GIF 循环”，而是一个**通用的图像编解码与处理引擎**。

下面我按**实际工程中最有价值的用途**给你系统性说明，并给出**可直接使用的命令示例**。

---

## 一、`convert` 的本质与定位

* 属于 **ImageMagick**
* 用于 **图像格式转换 + 图像处理**
* 支持 **200+ 图像格式**
* 常用于：

  * 后端图片处理服务
  * 批处理脚本
  * CI / 离线任务
  * GIF / WebP / PNG 优化

---

## 二、最常用的 12 类功能（工程常用）

---

## 1️⃣ 图片格式转换（最基础）

```bash
convert a.png b.jpg
convert a.jpg b.webp
convert a.png b.gif
```

---

## 2️⃣ 调整尺寸（等比 / 强制）

### 等比缩放（推荐）

```bash
convert in.jpg -resize 800x800 out.jpg
```

### 强制拉伸

```bash
convert in.jpg -resize 800x800! out.jpg
```

---

## 3️⃣ 压缩体积（非常实用）

### JPEG 压缩质量

```bash
convert in.jpg -quality 75 out.jpg
```

### WebP（强烈推荐）

```bash
convert in.png -quality 80 out.webp
```

---

## 4️⃣ 裁剪图片

```bash
convert in.jpg -crop 300x200+50+50 out.jpg
```

含义：

* 宽 300
* 高 200
* 从 `(50,50)` 开始裁剪

---

## 5️⃣ 旋转、翻转

```bash
convert in.jpg -rotate 90 out.jpg
convert in.jpg -flip out.jpg      # 上下
convert in.jpg -flop out.jpg      # 左右
```

---

## 6️⃣ GIF 相关（你刚用到的）

### 设置无限循环

```bash
convert in.gif -loop 0 out.gif
```

### 改帧率（减帧）

```bash
convert in.gif -delay 10 out.gif
```

### 拆分 GIF 帧

```bash
convert in.gif frame_%03d.png
```

---

## 7️⃣ 添加水印（后端常见需求）

```bash
convert in.jpg watermark.png \
  -gravity southeast -geometry +20+20 \
  -composite out.jpg
```

---

## 8️⃣ 文字绘制（验证码 / 标注）

```bash
convert in.jpg \
  -font DejaVu-Sans \
  -fill white \
  -pointsize 36 \
  -gravity center \
  -annotate +0+0 "Hello" \
  out.jpg
```

---

## 9️⃣ 拼接图片（横向 / 纵向）

### 横向拼接

```bash
convert a.jpg b.jpg +append out.jpg
```

### 纵向拼接

```bash
convert a.jpg b.jpg -append out.jpg
```

---

## 🔟 去 EXIF（隐私 / 体积）

```bash
convert in.jpg -strip out.jpg
```

---

## 1️⃣1️⃣ 颜色 / 灰度处理

### 灰度图

```bash
convert in.jpg -colorspace Gray out.jpg
```

### 降色（GIF / PNG）

```bash
convert in.png -colors 256 out.png
```

---

## 1️⃣2️⃣ 批量处理（生产中最重要）

### 批量转 WebP

```bash
for f in *.jpg; do
  convert "$f" "${f%.jpg}.webp"
done
```

### 批量改 GIF 为无限循环

```bash
for f in *.gif; do
  convert "$f" -loop 0 "loop_$f"
done
```

---

## 三、查看图片信息（调试必备）

```bash
identify image.gif
identify -verbose image.gif
```

---

## 四、`convert` vs `ffmpeg`（工程选型）

| 场景       | 推荐           |
| -------- | ------------ |
| 静态图片     | convert      |
| GIF 微调   | convert      |
| 视频 → GIF | ffmpeg       |
| 大规模压缩    | convert + 并发 |
| 实时视频     | ffmpeg       |

---

## 五、生产环境注意事项（很重要）

### ⚠️ 安全限制（Ubuntu 默认）

Ubuntu 对 ImageMagick 有安全策略限制：

```text
/etc/ImageMagick-6/policy.xml
```

可能禁用：

* PDF
* PS
* SVG

这是**正常的安全策略**。

---

## 六、总结一句话

> **`convert` 是 Linux 后端中最常用、最稳定的图像处理“瑞士军刀”之一，
> 从 GIF 循环、压缩、裁剪到水印，基本都能一行命令解决。**

---

如果你想把这些能力：

* **封装成 Go 服务**
* **做异步图片处理**
* **限制 CPU / 内存**
* **或替换为 WebP / AVIF**

可以直接说你的目标，我可以给你**架构级和命令级的方案**。
